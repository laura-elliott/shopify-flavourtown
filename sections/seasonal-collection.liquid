{%- liquid
  if collection.url.size == 0
    assign results_url = routes.all_products_collection_url
  else
    assign results_url = collection.url
  endif

  if results_url contains "?"
    assign results_url = results_url | split: "?" | first
  endif

-%}

{%- if section.settings.height == "fixed" -%}
  {%- style -%}
    {%- if section.settings.height == 'fixed' -%}
      {% if section.settings.header_mode == blank %}
        .collection-header .rimage-outer-wrapper,
        .collection-header .placeholder-image {
          height: {{ section.settings.height_mobile }}px;
        }
      {% elsif section.settings.header_mode == 'coloured-split' %}
        .collection-header .header-text,
        .collection-header .header-image {
          min-height: {{ section.settings.height_mobile }}px;
        }
      {%- endif -%}
    {%- endif -%}

    @media (min-width: 768px) {
      {%- if section.settings.height == 'fixed' -%}
        {% if section.settings.header_mode == blank %}
          .collection-header .rimage-outer-wrapper,
          .collection-header .placeholder-image {
          height: {{ section.settings.height_desktop }}px;
          }
        {% elsif section.settings.header_mode == 'coloured-split' %}
          .collection-header .header-text,
          .collection-header .header-image {
          min-height: {{ section.settings.height_desktop }}px;
          }
        {%- endif -%}
      {%- endif -%}
    }
  {%- endstyle -%}
{%- endif -%}

<div class="section collection-page"
     data-section-type="collection-template"
     data-components="price-range,accordion,sticky-scroll-direction"
     data-use-infinite-scroll="{{ section.settings.infinite_scroll_enabled }}"
     data-is-sticky="{{ section.settings.filters_sticky }}"
     data-ajax-filtering="{{ section.settings.ajax_products }}"
     {% if section.settings.filter_mode == "sidebar" %}data-is-sidebar="true"{% endif %}>

  {% paginate collection.products by section.settings.pagination_limit_int %}
    <div class="container">
      {% capture collection_header %}
        {%- if section.settings.header_mode == blank and collection.featured_image and section.settings.header_mode != "hidden" -%}
          <div class="collection-header cc-banner height--{{ section.settings.height }} {% if section.settings.image_overlay_style != "none" %}has-tint has-tint--{{ section.settings.image_overlay_style }}{% else %}no-tint{% endif %}" data-cc-animate>
						{% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
						<div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
              {%- if section.settings.height == 'natural' -%}
                <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%"></div>
              {%- endif -%}
              <noscript>
                <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                  <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                </div>
              </noscript>
            </div>

            {%- if collection.title != blank or collection.description != blank -%}
              <div class="image-overlay overlay--v-{{ section.settings.text_alignment | split: ' ' | first }} overlay--h-{{ section.settings.text_alignment | split: ' ' | last }} ">
                <div class="inner {% if section.settings.text_alignment contains "left" or  section.settings.text_alignment contains "right" %}container{% endif %}">
                  {%- if collection.title != blank -%}
                    <h1 class="line-1  line-1--large" data-cc-animate data-cc-animate-delay="0.3s">
                      {{ collection.title }}
                    </h1>
                  {%- endif -%}

                  {%- if collection.description != blank -%}
                    <div class="rte line-2"  data-cc-animate data-cc-animate-delay="0.4s">
                      {{ collection.description }}
                    </div>
                  {%- endif -%}
                </div>
              </div>
            {%- endif -%}
          </div>
        {%- elsif section.settings.header_mode != "hidden"  -%}

          {%- if section.settings.accordion_enabled == true -%}
            {%- if collection.metafields.custom.visible_text and collection.metafields.custom.expanded_text -%}

              <div class="cc-accordion collection-accordion cc-initialized" data-allow-multi-open="false">
                <details class="cc-accordion-item">
                  <summary class="cc-accordion-item__title">
                    <div class="collection-header
                    {{ section.settings.header_mode }}
                    {% if section.settings.height == "fixed" %}collection-header--fixed-height{% endif %} {% if collection.featured_image %}has-image{% endif %} handle-{{ collection.handle }}" data-cc-animate>
                      <div class="header-text
                      overlay--v-{{ section.settings.text_alignment | split: ' ' | first }}
                      overlay--h-{{ section.settings.text_alignment | split: ' ' | last }}">
                        <h1 class="page-title">{{ collection.title }}</h1>
                          {{ collection.metafields.custom.visible_text | metafield_tag }}  
                      </div>
                    {% if section.settings.header_mode == "coloured-split" and collection.featured_image %}
                      <div class="header-image">
                        {%- if collection.featured_image -%}
                          {% if section.settings.height == "fixed" %}
                            {% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
                            <div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
                              <noscript>
                                <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                                  <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                                </div>
                              </noscript>
                            </div>
                          {%- else -%}
                            {%- render 'responsive-image', image: collection.featured_image -%}
                          {%- endif -%}
                        {%- endif -%}
                      </div>
                    {% endif %}
                    </div>
                  </summary>
                <div class="cc-accordion-item__panel">
                  <div class="cc-accordion-item__content rte">
                      {{ collection.metafields.custom.expanded_text | metafield_tag }}  
                  </div>
                </div>
                </details>
              </div>

              {%- elsif collection.metafields.custom.visible_text -%}

                <div class="collection-header
                {{ section.settings.header_mode }}
                {% if section.settings.height == "fixed" %}collection-header--fixed-height{% endif %} {% if collection.featured_image %}has-image{% endif %} handle-{{ collection.handle }}" data-cc-animate>
                <div class="header-text
                  overlay--v-{{ section.settings.text_alignment | split: ' ' | first }}
                  overlay--h-{{ section.settings.text_alignment | split: ' ' | last }}">
                  <h1 class="page-title">{{ collection.title }}</h1>
    
                    <div class="rte">{{ collection.metafields.custom.visible_text | metafield_tag }}</div>
                </div>
    
                {% if section.settings.header_mode == "coloured-split" and collection.featured_image %}
                  <div class="header-image">
                    {%- if collection.featured_image -%}
                      {% if section.settings.height == "fixed" %}
    										{% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
    										<div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
                          <noscript>
                            <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                              <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                            </div>
                          </noscript>
                        </div>
                      {%- else -%}
                        {%- render 'responsive-image', image: collection.featured_image -%}
                      {%- endif -%}
                    {%- endif -%}
                  </div>
                {% endif %}
              </div>
      
              {%- elsif collection.metafields.custom.expanded_text -%}

                    <div class="collection-header
              {{ section.settings.header_mode }}
              {% if section.settings.height == "fixed" %}collection-header--fixed-height{% endif %} {% if collection.featured_image %}has-image{% endif %} handle-{{ collection.handle }}" data-cc-animate>
              <div class="header-text
                overlay--v-{{ section.settings.text_alignment | split: ' ' | first }}
                overlay--h-{{ section.settings.text_alignment | split: ' ' | last }}">
                <h1 class="page-title">{{ collection.title }}</h1>
  
                  <div class="rte">{{ collection.metafields.custom.visible_text | metafield_tag }}</div>
              </div>
  
              {% if section.settings.header_mode == "coloured-split" and collection.featured_image %}
                <div class="header-image">
                  {%- if collection.featured_image -%}
                    {% if section.settings.height == "fixed" %}
  										{% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
  										<div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
                        <noscript>
                          <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                            <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                          </div>
                        </noscript>
                      </div>
                    {%- else -%}
                      {%- render 'responsive-image', image: collection.featured_image -%}
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {% endif %}
            </div>
              
            {%- else -%}

              <div class="collection-header
              {{ section.settings.header_mode }}
              {% if section.settings.height == "fixed" %}collection-header--fixed-height{% endif %} {% if collection.featured_image %}has-image{% endif %} handle-{{ collection.handle }}" data-cc-animate>
              <div class="header-text
                overlay--v-{{ section.settings.text_alignment | split: ' ' | first }}
                overlay--h-{{ section.settings.text_alignment | split: ' ' | last }}">
                <h1 class="page-title">{{ collection.title }}</h1>
  
                {% if collection.description != blank %}
                  <div class="rte">{{ collection.description }}</div>
                {% endif %}
              </div>
  
              {% if section.settings.header_mode == "coloured-split" and collection.featured_image %}
                <div class="header-image">
                  {%- if collection.featured_image -%}
                    {% if section.settings.height == "fixed" %}
  										{% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
  										<div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
                        <noscript>
                          <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                            <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                          </div>
                        </noscript>
                      </div>
                    {%- else -%}
                      {%- render 'responsive-image', image: collection.featured_image -%}
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {% endif %}
            </div>
      
              {%- endif -%}
                
          {%- else -%}
              
      
            <div class="collection-header
              {{ section.settings.header_mode }}
              {% if section.settings.height == "fixed" %}collection-header--fixed-height{% endif %} {% if collection.featured_image %}has-image{% endif %} handle-{{ collection.handle }}" data-cc-animate>
              <div class="header-text
                overlay--v-{{ section.settings.text_alignment | split: ' ' | first }}
                overlay--h-{{ section.settings.text_alignment | split: ' ' | last }}">
                <h1 class="page-title">{{ collection.title }}</h1>
  
                {% if collection.description != blank %}
                  <div class="rte">{{ collection.description }}</div>
                {% endif %}
              </div>
  
              {% if section.settings.header_mode == "coloured-split" and collection.featured_image %}
                <div class="header-image">
                  {%- if collection.featured_image -%}
                    {% if section.settings.height == "fixed" %}
  										{% assign img_url = collection.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' %}
  										<div class="rimage-outer-wrapper rimage-background" data-lazy-bg="{{ img_url }}">
                        <noscript>
                          <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
                            <img src="{{ collection.featured_image | img_url: '1024x1024' }}" alt="{{ collection.featured_image.alt | escape }}" class="rimage__image">
                          </div>
                        </noscript>
                      </div>
                    {%- else -%}
                      {%- render 'responsive-image', image: collection.featured_image -%}
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {% endif %}
            </div>
          {%- endif  -%}
        {%- endif -%}
      {% endcapture %}

      {% if section.settings.breadcrumb_align == "above_heading" %}
        <div class="collection-breadcrumb collection-breadcrumb--above inline-row cf no-margin-top" data-cc-animate>
          {% render 'breadcrumbs' %}
        </div>
      {% endif %}

      {{ collection_header }}

      {% if section.settings.breadcrumb_align == "below_heading" %}
        <div class="collection-breadcrumb inline-row cf collection-breadcrumb--below" data-cc-animate>
          {% render 'breadcrumbs' %}
        </div>
      {% endif %}



    </div>
  {% endpaginate %}
</div>

{% schema %}
{
	"name": "Collection pages",
	"class": "main-collection-section",
	"settings": [{
			"type": "header",
			"content": "Heading"
		},
		{
			"type": "select",
			"id": "header_mode",
			"label": "Layout",
			"options": [{
					"value": "hidden",
					"label": "No heading"
				},
				{
					"value": "",
					"label": "Text over image"
				},
				{
					"value": "coloured-split",
					"label": "Text next to image"
				},
				{
					"value": "text-only",
					"label": "No image"
				}
			],
			"default": "coloured-split"
		},
		{
			"type": "checkbox",
			"id": "accordion_enabled",
			"label": "Use metafields in accordion",
			"default": false
		},
		{
			"type": "radio",
			"id": "height",
			"label": "Height",
			"default": "natural",
			"options": [{
					"value": "natural",
					"label": "Natural"
				},
				{
					"value": "fixed",
					"label": "Fixed height"
				}
			]
		},
		{
			"type": "range",
			"id": "height_desktop",
			"min": 200,
			"max": 650,
			"step": 50,
			"unit": "px",
			"label": "Desktop fixed height",
			"default": 350
		},
		{
			"type": "range",
			"id": "height_mobile",
			"min": 100,
			"max": 1000,
			"step": 50,
			"unit": "px",
			"label": "Mobile fixed height",
			"default": 250
		},
		{
			"type": "select",
			"id": "image_overlay_style",
			"label": "Image tint",
			"info": "Applies to 'Text over image' layout only.",
			"default": "standard",
			"options": [{
					"label": "None",
					"value": "none"
				},
				{
					"label": "Standard",
					"value": "standard"
				},
				{
					"label": "Vignette",
					"value": "vignette"
				},
				{
					"label": "Text shadow",
					"value": "shadow"
				},
				{
					"label": "Bottom",
					"value": "bottom"
				},
				{
					"label": "Top",
					"value": "top"
				}
			]
		},
		{
			"type": "select",
			"id": "text_alignment",
			"label": "Text alignment",
			"options": [{
					"value": "top left",
					"label": "Top left"
				},
				{
					"value": "top center",
					"label": "Top center"
				},
				{
					"value": "top right",
					"label": "Top right"
				},
				{
					"value": "center left",
					"label": "Middle left"
				},
				{
					"value": "center center",
					"label": "Middle center"
				},
				{
					"value": "center right",
					"label": "Middle right"
				},
				{
					"value": "bottom left",
					"label": "Bottom left"
				},
				{
					"value": "bottom center",
					"label": "Bottom center"
				},
				{
					"value": "bottom right",
					"label": "Bottom right"
				}
			],
			"default": "center center"
		},
		{
			"type": "select",
			"id": "breadcrumb_align",
			"label": "Breadcrumb",
			"default": "above_heading",
			"options": [{
					"value": "none",
					"label": "None"
				},
				{
					"value": "above_heading",
					"label": "Above the heading"
				},
				{
					"value": "below_heading",
					"label": "Below the heading"
				}
			]
		}
	]
}
{% endschema %}
